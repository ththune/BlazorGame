@using System.Timers
@using BlazorGame.GameLogic

@implements IDisposable

@code {
    [Parameter] public int Rows { get; set; } = 30;
    [Parameter] public int Columns { get; set; } = 30;
    private BoardLogic _board = null!;
    private SnakeLogic _snake = null!;
    private Timer? _timer;
    private ElementReference _boardRef;
    private bool _hasFocused;
    private static readonly Random Random = new();


    // Initialize this component
    protected override void OnInitialized()
    {
        _board = new BoardLogic(Rows, Columns);
        _snake = new SnakeLogic(Rows / 2, Columns / 2);

        _timer = new Timer(200);
        _timer.Elapsed += (_, _) => MoveSnake();

        _timer.Start();
        base.OnInitialized();
    }

    private bool IsSnakeCell(int row, int column) =>
        _snake.Body.Any(body => body.Row == row && body.Column == column);

    private void MoveSnake()
    {
        InvokeAsync(() =>
        {
            var grow = Random.Next(10) < 2; // 20% chance to grow
            _snake.Move(grow);
            StateHasChanged();
        });
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        Direction? newDirection = e.Key switch
        {
            "ArrowUp" or "w" or "W" => Direction.Up,
            "ArrowDown" or "s" or "S" => Direction.Down,
            "ArrowLeft" or "a" or "A" => Direction.Left,
            "ArrowRight" or "d" or "D" => Direction.Right,
            _ => null
        };

        if (newDirection.HasValue) _snake.ChangeDirection(newDirection.Value);
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_hasFocused)
        {
            _hasFocused = true;
            await _boardRef.FocusAsync();
        }
    }


    public void Dispose()
    {
        _timer?.Stop();
        _timer?.Dispose();
    }

}

<div class="board" style="--rows: @Rows; --columns: @Columns;" tabindex="0" @onkeydown="HandleKeyDown" @ref="_boardRef">
    @for (var row = 0; row < _board.Rows; row++)
    {
        <div class="board-row">
            @for (var column = 0; column < _board.Columns; column++)
            {
                var snakeClass = IsSnakeCell(row, column) ? "snake-cell" : "";
                <div class="board-cell @snakeClass"></div>
            }
        </div>
    }
</div> 

